<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>航海勤務記録 - 日別/週集計</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; line-height: 1.4; }
    h1, h2, h3 { margin: 0 0 10px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .grid { display: grid; gap: 8px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .grid-4 { grid-template-columns: repeat(4, minmax(0,1fr)); }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    label { display: block; font-size: 12px; color: #444; margin-bottom: 4px; }
    input[type="number"], input[type="date"], input[type="text"] {
      width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; border-radius: 8px;
    }
    .inline { display: inline-flex; align-items: center; gap: 6px; margin-right: 10px; }
    button {
      border: 1px solid #bbb; background: #fff; border-radius: 8px; padding: 8px 12px; cursor: pointer;
    }
    button:hover { background: #f5f5f5; }
    .tab-btn.active { background: #eef6ff; border-color: #8bbcff; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { border-bottom: 1px solid #eee; padding: 6px; text-align: left; vertical-align: middle; }
    th { background: #fafafa; position: sticky; top: 0; }
    .num { text-align: right; white-space: nowrap; }
    .muted { color: #666; font-size: 12px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f0f0f0; font-size: 12px; }
    .summary { font-weight: 700; font-size: 18px; }
    .hidden { display: none !important; }
    .linkish { color: #0b66c3; text-decoration: underline; cursor: pointer; background: none; border: none; padding: 0; }
    @media (max-width: 900px) {
      .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
      table { font-size: 12px; }
      input, button { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="row" style="justify-content: space-between;">
    <h1>航海勤務記録（日別入力 / 週集計）</h1>
    <a href="./index.html">← 単価計算へ戻る</a>
  </div>

  <!-- タブ -->
  <div class="card">
    <div class="row">
      <button id="showDailyBtn" class="tab-btn active" type="button">日別入力</button>
      <button id="showWeeklyBtn" class="tab-btn" type="button">週集計・単価設定</button>
      <span id="modeBadgeTop" class="pill">船員法</span>
    </div>
    <div class="muted" style="margin-top: 6px;">
      単価設定（基礎時給・残業単価）は「週集計・単価設定」タブにあります。
    </div>
  </div>

  <!-- 日別入力タブ -->
  <section id="dailySection">
    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <h2>日別入力</h2>
        <div class="row">
          <button id="addRowBtn" type="button">+ 行を追加</button>
          <button id="clearRowsBtn" type="button">行を全削除</button>
          <button id="goWeeklyBtn" type="button">週集計を見る →</button>
        </div>
      </div>

      <div class="row" style="margin-bottom: 8px;">
        <span class="muted">現在の単価（設定は週集計タブ）</span>
        <span id="miniBaseHourly" class="pill">基礎時給 0円/h</span>
        <span id="miniOtUnit" class="pill">残業単価 0円/h</span>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>日付</th>
              <th class="num">時間外(h)</th>
              <th id="nightColHead" class="num">深夜(h)</th>
              <th>メモ</th>
              <th class="num">日額</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="dailyTbody"></tbody>
        </table>
      </div>

      <div class="grid grid-4" style="margin-top:12px;">
        <div class="card" style="margin:0;">
          <div class="muted">時間外 合計</div>
          <div id="sumOtHours" class="summary">0.00 h</div>
        </div>
        <div class="card" style="margin:0;" id="sumNightCard">
          <div class="muted">深夜 合計</div>
          <div id="sumNightHours" class="summary">0.00 h</div>
        </div>
        <div class="card" style="margin:0;">
          <div class="muted">概算合計</div>
          <div id="sumAmount" class="summary">0 円</div>
        </div>
        <div class="card" style="margin:0;">
          <div class="muted">保存</div>
          <div class="row">
            <button id="saveBtn" type="button">保存</button>
            <button id="loadBtn" type="button">読込</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 週集計・単価設定タブ -->
  <section id="weeklySection" class="hidden">
    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <h2>週集計・単価設定</h2>
        <button id="backToDailyBtn" type="button">← 日別入力に戻る</button>
      </div>

      <h3>計算モード</h3>
      <div class="row">
        <label class="inline">
          <input type="radio" name="mode" value="seaman" checked>
          船員法モード
        </label>
        <label class="inline">
          <input type="radio" name="mode" value="labor">
          労基法モード
        </label>
        <span id="modeBadgeWeekly" class="pill">船員法</span>
      </div>
      <div class="muted" style="margin-top:6px; margin-bottom: 10px;">
        船員法モードでは深夜欄を非表示、時間外倍率は初期値 1.30。
      </div>

      <!-- 単価前提（←ここに移動） -->
      <h3>単価前提</h3>
      <div class="grid grid-4">
        <div>
          <label>本給（月額）</label>
          <input id="basePay" type="number" min="0" step="1" value="0">
        </div>
        <div>
          <label>乗船手当（月額）</label>
          <input id="voyageAllowance" type="number" min="0" step="1" value="0">
        </div>
        <div>
          <label>定額残業代（月額）</label>
          <input id="fixedOt" type="number" min="0" step="1" value="0">
        </div>
        <div>
          <label>その他（月額）</label>
          <input id="otherAllowance" type="number" min="0" step="1" value="0">
        </div>
      </div>

      <div class="grid grid-4" style="margin-top:10px;">
        <div>
          <label>月平均所定労働時間</label>
          <input id="monthlyHours" type="number" min="1" step="0.01" value="173">
        </div>
        <div>
          <label>時間外倍率</label>
          <input id="otMultiplier" type="number" min="1" step="0.01" value="1.30">
        </div>
        <div id="nightRateWrap">
          <label>深夜割増率（追加分）</label>
          <input id="nightExtraRate" type="number" min="0" step="0.01" value="0.25">
        </div>
        <div>
          <label>算定基礎に含める</label>
          <div class="row" style="margin-top:8px;">
            <label class="inline"><input type="checkbox" id="incBasePay" checked>本給</label>
            <label class="inline"><input type="checkbox" id="incVoyage" checked>乗船</label>
            <label class="inline"><input type="checkbox" id="incFixedOt">定残</label>
            <label class="inline"><input type="checkbox" id="incOther">その他</label>
          </div>
        </div>
      </div>

      <div class="grid grid-3" style="margin-top:12px;">
        <div class="card" style="margin:0;">
          <div class="muted">割増算定基礎賃金（月額）</div>
          <div id="basisMonthly" class="summary">0 円</div>
        </div>
        <div class="card" style="margin:0;">
          <div class="muted">基礎時給</div>
          <div id="baseHourly" class="summary">0 円/h</div>
        </div>
        <div class="card" style="margin:0;">
          <div class="muted">残業単価</div>
          <div id="otUnit" class="summary">0 円/h</div>
        </div>
      </div>

      <div class="muted" id="formulaText" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <h3>週集計</h3>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>週（Mon-Sun）</th>
              <th class="num">時間外(h)</th>
              <th id="weeklyNightHead" class="num">深夜(h)</th>
              <th class="num">週合計</th>
            </tr>
          </thead>
          <tbody id="weeklyTbody"></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top: 8px;">
        ※ 労基法モードの深夜は「追加分」の簡易計算（時間外との重複調整なし）。
      </div>
    </div>
  </section>

  <script>
    const STORAGE_KEY = 'maritime_daily_weekly_v2';

    const els = {
      // tabs
      showDailyBtn: document.getElementById('showDailyBtn'),
      showWeeklyBtn: document.getElementById('showWeeklyBtn'),
      goWeeklyBtn: document.getElementById('goWeeklyBtn'),
      backToDailyBtn: document.getElementById('backToDailyBtn'),
      dailySection: document.getElementById('dailySection'),
      weeklySection: document.getElementById('weeklySection'),

      // mode
      modeRadios: () => [...document.querySelectorAll('input[name="mode"]')],
      modeBadgeTop: document.getElementById('modeBadgeTop'),
      modeBadgeWeekly: document.getElementById('modeBadgeWeekly'),

      // pricing inputs
      basePay: document.getElementById('basePay'),
      voyageAllowance: document.getElementById('voyageAllowance'),
      fixedOt: document.getElementById('fixedOt'),
      otherAllowance: document.getElementById('otherAllowance'),
      monthlyHours: document.getElementById('monthlyHours'),
      otMultiplier: document.getElementById('otMultiplier'),
      nightExtraRate: document.getElementById('nightExtraRate'),
      nightRateWrap: document.getElementById('nightRateWrap'),
      incBasePay: document.getElementById('incBasePay'),
      incVoyage: document.getElementById('incVoyage'),
      incFixedOt: document.getElementById('incFixedOt'),
      incOther: document.getElementById('incOther'),

      // pricing outputs
      basisMonthly: document.getElementById('basisMonthly'),
      baseHourly: document.getElementById('baseHourly'),
      otUnit: document.getElementById('otUnit'),
      formulaText: document.getElementById('formulaText'),
      miniBaseHourly: document.getElementById('miniBaseHourly'),
      miniOtUnit: document.getElementById('miniOtUnit'),

      // daily table
      addRowBtn: document.getElementById('addRowBtn'),
      clearRowsBtn: document.getElementById('clearRowsBtn'),
      dailyTbody: document.getElementById('dailyTbody'),
      nightColHead: document.getElementById('nightColHead'),

      // daily totals
      sumOtHours: document.getElementById('sumOtHours'),
      sumNightCard: document.getElementById('sumNightCard'),
      sumNightHours: document.getElementById('sumNightHours'),
      sumAmount: document.getElementById('sumAmount'),

      // weekly
      weeklyTbody: document.getElementById('weeklyTbody'),
      weeklyNightHead: document.getElementById('weeklyNightHead'),

      // save/load
      saveBtn: document.getElementById('saveBtn'),
      loadBtn: document.getElementById('loadBtn'),
    };

    function n(v) {
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    }

    function yen(v) {
      return Math.round(v).toLocaleString('ja-JP') + ' 円';
    }

    function yenPerH(v) {
      return Math.round(v).toLocaleString('ja-JP') + ' 円/h';
    }

    function getMode() {
      return els.modeRadios().find(r => r.checked)?.value || 'seaman';
    }

    function setMode(mode, applyDefaultMultiplier = false) {
      els.modeRadios().forEach(r => { r.checked = (r.value === mode); });

      const isSeaman = mode === 'seaman';
      const modeText = isSeaman ? '船員法' : '労基法';
      els.modeBadgeTop.textContent = modeText;
      els.modeBadgeWeekly.textContent = modeText;

      // モード切替時のデフォ倍率
      if (applyDefaultMultiplier) {
        els.otMultiplier.value = isSeaman ? '1.30' : '1.25';
      }

      // 深夜欄の表示制御
      els.nightRateWrap.classList.toggle('hidden', isSeaman);
      els.nightColHead.classList.toggle('hidden', isSeaman);
      els.weeklyNightHead.classList.toggle('hidden', isSeaman);
      els.sumNightCard.classList.toggle('hidden', isSeaman);

      // 行側の深夜セルも隠す
      [...document.querySelectorAll('.night-col')].forEach(td => {
        td.classList.toggle('hidden', isSeaman);
      });

      recalcAll();
    }

    function showTab(tabName) {
      const isDaily = tabName === 'daily';
      els.dailySection.classList.toggle('hidden', !isDaily);
      els.weeklySection.classList.toggle('hidden', isDaily);
      els.showDailyBtn.classList.toggle('active', isDaily);
      els.showWeeklyBtn.classList.toggle('active', !isDaily);

      if (!isDaily) recalcAll();
    }

    function addRow(data = {}) {
      const tr = document.createElement('tr');

      const tdDate = document.createElement('td');
      const inputDate = document.createElement('input');
      inputDate.type = 'date';
      inputDate.value = data.date || '';
      tdDate.appendChild(inputDate);

      const tdOt = document.createElement('td');
      tdOt.className = 'num';
      const inputOt = document.createElement('input');
      inputOt.type = 'number';
      inputOt.min = '0';
      inputOt.step = '0.01';
      inputOt.value = data.otHours ?? '';
      tdOt.appendChild(inputOt);

      const tdNight = document.createElement('td');
      tdNight.className = 'num night-col';
      const inputNight = document.createElement('input');
      inputNight.type = 'number';
      inputNight.min = '0';
      inputNight.step = '0.01';
      inputNight.value = data.nightHours ?? '';
      tdNight.appendChild(inputNight);

      const tdMemo = document.createElement('td');
      const inputMemo = document.createElement('input');
      inputMemo.type = 'text';
      inputMemo.value = data.memo || '';
      tdMemo.appendChild(inputMemo);

      const tdAmount = document.createElement('td');
      tdAmount.className = 'num';
      const spanAmount = document.createElement('span');
      spanAmount.textContent = '0 円';
      tdAmount.appendChild(spanAmount);

      const tdDel = document.createElement('td');
      tdDel.className = 'num';
      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.textContent = '削除';
      tdDel.appendChild(delBtn);

      tr.append(tdDate, tdOt, tdNight, tdMemo, tdAmount, tdDel);
      els.dailyTbody.appendChild(tr);

      // 再計算イベント
      [inputDate, inputOt, inputNight, inputMemo].forEach(el => {
        el.addEventListener('input', recalcAll);
      });
      delBtn.addEventListener('click', () => {
        tr.remove();
        recalcAll();
      });

      // モードに合わせて深夜列の表示状態を同期
      const isSeaman = getMode() === 'seaman';
      tdNight.classList.toggle('hidden', isSeaman);

      recalcAll();
    }

    function getRowObjects() {
      const rows = [];
      [...els.dailyTbody.querySelectorAll('tr')].forEach(tr => {
        const tds = tr.querySelectorAll('td');
        const date = tds[0].querySelector('input').value;
        const otHours = n(tds[1].querySelector('input').value);
        const nightHours = n(tds[2].querySelector('input').value);
        const memo = tds[3].querySelector('input').value || '';
        rows.push({ tr, date, otHours, nightHours, memo });
      });
      return rows;
    }

    function calcRates() {
      const basisMonthly =
        (els.incBasePay.checked ? n(els.basePay.value) : 0) +
        (els.incVoyage.checked ? n(els.voyageAllowance.value) : 0) +
        (els.incFixedOt.checked ? n(els.fixedOt.value) : 0) +
        (els.incOther.checked ? n(els.otherAllowance.value) : 0);

      const monthlyHours = Math.max(n(els.monthlyHours.value), 1);
      const otMultiplier = Math.max(n(els.otMultiplier.value), 1);
      const nightExtraRate = Math.max(n(els.nightExtraRate.value), 0);

      const baseHourly = basisMonthly / monthlyHours;
      const otUnit = baseHourly * otMultiplier;

      return { basisMonthly, monthlyHours, otMultiplier, nightExtraRate, baseHourly, otUnit };
    }

    function weekRangeLabel(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr + 'T00:00:00');
      if (Number.isNaN(d.getTime())) return '';

      const day = d.getDay(); // Sun=0
      const diffToMon = (day === 0 ? -6 : 1 - day);
      const mon = new Date(d);
      mon.setDate(d.getDate() + diffToMon);

      const sun = new Date(mon);
      sun.setDate(mon.getDate() + 6);

      const fmt = x => {
        const y = x.getFullYear();
        const m = String(x.getMonth() + 1).padStart(2, '0');
        const dd = String(x.getDate()).padStart(2, '0');
        return `${y}-${m}-${dd}`;
      };

      return `${fmt(mon)} ～ ${fmt(sun)}`;
    }

    function recalcAll() {
      const mode = getMode();
      const isSeaman = mode === 'seaman';
      const rates = calcRates();

      // 単価表示
      els.basisMonthly.textContent = yen(rates.basisMonthly);
      els.baseHourly.textContent = yenPerH(rates.baseHourly);
      els.otUnit.textContent = yenPerH(rates.otUnit);
      els.miniBaseHourly.textContent = `基礎時給 ${yenPerH(rates.baseHourly)}`;
      els.miniOtUnit.textContent = `残業単価 ${yenPerH(rates.otUnit)}`;

      const parts = [];
      if (els.incBasePay.checked) parts.push('本給');
      if (els.incVoyage.checked) parts.push('乗船手当');
      if (els.incFixedOt.checked) parts.push('定額残業代');
      if (els.incOther.checked) parts.push('その他');
      els.formulaText.textContent =
        `式: (${parts.length ? parts.join(' + ') : '0'}) ÷ ${rates.monthlyHours} × ${rates.otMultiplier.toFixed(2)} = 残業単価`;

      // 日別計算 + 週集計元データ
      let sumOt = 0;
      let sumNight = 0;
      let sumAmount = 0;

      const weeklyMap = new Map(); // key: "YYYY-MM-DD ～ YYYY-MM-DD"

      const rows = getRowObjects();
      for (const row of rows) {
        const dayAmountOt = row.otHours * rates.otUnit;
        const dayAmountNight = isSeaman ? 0 : (row.nightHours * rates.baseHourly * rates.nightExtraRate);
        const dayAmount = dayAmountOt + dayAmountNight;

        // 日別の金額セル更新
        const amountSpan = row.tr.querySelectorAll('td')[4].querySelector('span');
        amountSpan.textContent = yen(dayAmount);

        sumOt += row.otHours;
        sumNight += row.nightHours;
        sumAmount += dayAmount;

        if (row.date) {
          const wk = weekRangeLabel(row.date);
          if (!weeklyMap.has(wk)) {
            weeklyMap.set(wk, { ot: 0, night: 0, amount: 0 });
          }
          const agg = weeklyMap.get(wk);
          agg.ot += row.otHours;
          agg.night += row.nightHours;
          agg.amount += dayAmount;
        }
      }

      // 日別合計
      els.sumOtHours.textContent = `${sumOt.toFixed(2)} h`;
      els.sumNightHours.textContent = `${sumNight.toFixed(2)} h`;
      els.sumAmount.textContent = yen(sumAmount);

      // 週集計テーブル描画（週順に並べる）
      els.weeklyTbody.innerHTML = '';
      const weekEntries = [...weeklyMap.entries()].sort((a, b) => a[0].localeCompare(b[0], 'ja'));

      if (weekEntries.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="${isSeaman ? 3 : 4}" class="muted">日別入力に日付を入れると週集計が表示されます。</td>`;
        els.weeklyTbody.appendChild(tr);
      } else {
        for (const [label, agg] of weekEntries) {
          const tr = document.createElement('tr');

          const tdWeek = document.createElement('td');
          tdWeek.textContent = label;

          const tdOt = document.createElement('td');
          tdOt.className = 'num';
          tdOt.textContent = agg.ot.toFixed(2);

          const tdNight = document.createElement('td');
          tdNight.className = 'num';
          tdNight.textContent = agg.night.toFixed(2);
          tdNight.classList.toggle('hidden', isSeaman);

          const tdAmt = document.createElement('td');
          tdAmt.className = 'num';
          tdAmt.textContent = yen(agg.amount);

          tr.append(tdWeek, tdOt, tdNight, tdAmt);
          els.weeklyTbody.appendChild(tr);
        }
      }
    }

    function saveData() {
      const payload = {
        mode: getMode(),
        pricing: {
          basePay: els.basePay.value,
          voyageAllowance: els.voyageAllowance.value,
          fixedOt: els.fixedOt.value,
          otherAllowance: els.otherAllowance.value,
          monthlyHours: els.monthlyHours.value,
          otMultiplier: els.otMultiplier.value,
          nightExtraRate: els.nightExtraRate.value,
          incBasePay: els.incBasePay.checked,
          incVoyage: els.incVoyage.checked,
          incFixedOt: els.incFixedOt.checked,
          incOther: els.incOther.checked,
        },
        rows: getRowObjects().map(r => ({
          date: r.date,
          otHours: r.otHours,
          nightHours: r.nightHours,
          memo: r.memo
        }))
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      alert('保存しました');
    }

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        alert('保存データがありません');
        return;
      }
      try {
        const d = JSON.parse(raw);

        // pricing
        const p = d.pricing || {};
        els.basePay.value = p.basePay ?? '0';
        els.voyageAllowance.value = p.voyageAllowance ?? '0';
        els.fixedOt.value = p.fixedOt ?? '0';
        els.otherAllowance.value = p.otherAllowance ?? '0';
        els.monthlyHours.value = p.monthlyHours ?? '173';
        els.otMultiplier.value = p.otMultiplier ?? '1.30';
        els.nightExtraRate.value = p.nightExtraRate ?? '0.25';
        els.incBasePay.checked = !!p.incBasePay;
        els.incVoyage.checked = !!p.incVoyage;
        els.incFixedOt.checked = !!p.incFixedOt;
        els.incOther.checked = !!p.incOther;

        // rows
        els.dailyTbody.innerHTML = '';
        (d.rows || []).forEach(r => addRow(r));
        if ((d.rows || []).length === 0) addRow();

        // mode（最後に反映）
        setMode(d.mode === 'labor' ? 'labor' : 'seaman', false);

        recalcAll();
        alert('読込しました');
      } catch (e) {
        alert('読込に失敗しました');
      }
    }

    // イベント登録
    els.showDailyBtn.addEventListener('click', () => showTab('daily'));
    els.showWeeklyBtn.addEventListener('click', () => showTab('weekly'));
    els.goWeeklyBtn.addEventListener('click', () => showTab('weekly'));
    els.backToDailyBtn.addEventListener('click', () => showTab('daily'));

    els.addRowBtn.addEventListener('click', () => addRow());
    els.clearRowsBtn.addEventListener('click', () => {
      if (!confirm('日別入力をすべて削除しますか？')) return;
      els.dailyTbody.innerHTML = '';
      addRow();
      recalcAll();
    });

    [
      els.basePay, els.voyageAllowance, els.fixedOt, els.otherAllowance,
      els.monthlyHours, els.otMultiplier, els.nightExtraRate,
      els.incBasePay, els.incVoyage, els.incFixedOt, els.incOther
    ].forEach(el => {
      el.addEventListener('input', recalcAll);
      el.addEventListener('change', recalcAll);
    });

    els.modeRadios().forEach(r => {
      r.addEventListener('change', () => {
        if (!r.checked) return;
        // モード切替時に倍率初期値を入れる（ユーザー希望）
        setMode(r.value, true);
      });
    });

    els.saveBtn.addEventListener('click', saveData);
    els.loadBtn.addEventListener('click', loadData);

    // 初期化
    addRow();
    setMode('seaman', false);
    recalcAll();
  </script>
</body>
</html>
